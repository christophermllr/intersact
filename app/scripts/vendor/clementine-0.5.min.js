/**
 * Copyright (c) 2010-12 ClementineJS

 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:

 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

function noop(){}function clone(a){var b,c=a instanceof Array?[]:{};for(b in a)b!=="clone"&&(c[b]=a[b]&&a[b]instanceof Date?new Date(a[b]):a[b]&&typeof a[b]=="object"?clone(a[b]):a[b]);return c}function proxy(a,b){var c=b;return function(){return a.apply(c,arguments)}}typeof console=="undefined"&&(console={log:function(){},dir:function(){}}),jQuery.fn.childrenTo=function(a){var b=[],c=this;return this.find(a).each(function(){var a=!1,d=$(this).parent();while(d.length!==0&&!a){if($(d).not($(c)).length===0){a=!0;break}if($(d).not("[data-control]").length===0){a=!1;break}d=$(d).parent()}a&&b.push($(this))}),b},jQuery.fn.outerHTML=function(a){return a?this.before(a).remove():jQuery("<p>").append(this.eq(0).clone()).html()},String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},function(){var a,b,c,d,e,f={};b=function(){function c(){}var a=!1,b=/\b_super\b/;return c.extend=function(d){function h(){!a&&this.initialize&&this.initialize.apply(this,arguments)}var e,f,g=this.prototype;a=!0,e=new this,a=!1;for(f in d)e[f]=typeof d[f]=="function"&&typeof g[f]=="function"&&b.test(d[f])?function(a,b){return function(){var c=this._super;this._super=g[a];var d=b.apply(this,arguments);return this._super=c,d}}(f,d[f]):d[f];return h.prototype=e,h.prototype.constructor=h,h.extend=c.extend,h.include=c.include,h},c.include=function(a){var b,c;if(!a)throw"Missing definition";for(b in a)c=a[b],0>Array.prototype.indexOf.call(["extend","include"],b)&&(this.prototype[b]=c);return this},c}(),d=function(){function a(a,b,c,d){this.bubbles=!0,this.currentTarget=b,this.data=d,this.target=c,this.type=a}return a.prototype.stopPropagation=function(){this.bubbles=!1},a}(),e=function(){function a(a,b,c){this.call=c,this.ev=b,this.target=a}return a.prototype.detach=function(){this.target.detach(this.ev,this.call),delete this.target,delete this.ev,delete this.call},a}(),c={on:function(a,b,c){var d=c!==void 0?proxy(b,c):b;return this._listeners||(this._listeners={}),this._listeners.hasOwnProperty(a)||(this._listeners[a]=[]),this._listeners[a].push(d),new e(this,a,d)},once:function(a,b,c){var d=c!==void 0?proxy(b,c):b,e=function(){b.apply(this,arguments),this.detach(a,d)};this.on(a,e)},fire:function(a,b){var c=this._parent||null,e=a;if(typeof a=="string"&&(a=new d(a,this,this,b)),typeof a.type!="string")throw"Error: Invalid 'type' when firing event";if(this._listeners||(this._listeners={}),this._listeners[a.type]instanceof Array)for(var f=this._listeners[a.type],g=0,h=f.length;h>g;g++)f[g].call(this,a,b);var i=!1;if(this._ignoreEvents instanceof Array)for(var g=0;this._ignoreEvents.length>g;g++)this._ignoreEvents[g]===e&&(i=!0);c!=null&&!i&&a.bubbles&&e[0]!=="_"&&(a.currentTarget=this._parent,c.fire.call(c,a,b))},detach:function(a,b){var c=[];if(this._listeners||(this._listeners={}),a===void 0)this._listeners={};else if(this._listeners[a]instanceof Array)if(b!==void 0){c=this._listeners[a];for(var d=0,e=c.length;e>d;d++)if(c[d]===b){c.splice(d,1);break}}else this._listeners[a]=[]}},a={touch:"ontouchstart"in window||window.hasOwnProperty("DocumentTouch")&&document instanceof DocumentTouch,location:"geolocation"in navigator},f=this.Clementine={modules:{}},f.version="0.5.0",f.Browser=a=a,f.Class=this.Class=b,f.Events=this.Events=c,f.EventHandle=e}.call(this),Array.prototype.clone=function(){return this.slice(0)},Array.prototype.indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},Array.prototype.first=[].first||function(){return this.length?this[0]:null},Array.prototype.last=[].last||function(){return this.length?this[this.length-1]:null},function(a){function g(a,b){b=$(b).eq(0),a=$(a).get(0);for(var c=0;a.attributes.length>c;c++){var d=a.attributes[c];b.attr(d.name,d.value)}}function h(a,b){for(var c=$(a).get(0),d={},e=[],f=0,g=c.attributes.length;g>f;f++)c.attributes[f].name.match(b)&&(d[c.attributes[f].name.replace(b,"")]=c.attributes[f].value,e.push(c.attributes[f].name));for(var h=0;e.length>h;h++)$(a).removeAttr(e[h]);return d}var b,c=window.Browser||a.Browser;a.Element,a.Queue,a.View,b=Class.extend({initialize:function(b,c,d){this._initialized=!1,this._parent=b||null,this._target=$(c),this.target=this._target,this._app=d,this._params={},(!this._target||this._target.length===0&&typeof this.getDefaultView=="function")&&(this._target=a.View.get(this.getDefaultView())),this._source=this._target.outerHTML(),this._ignoreEvents=["load","appear","disappear","unload"],this._attrs=this.setupAttributes(),this._views=this.setupViews(),this._elems=this.setupElements(),this._loaded=!1,this._visible=!1,this._running=!1,this._loadEvts=[],this._unloadEvts=[],this._showEvts=[],this._hideEvts=[],this._queue=[],this.state,typeof this._target=="object"&&this._target.addClass("hidden"),this.setup(),this._initialized=!0},getDefaultRoute:function(){return null},getDefaultView:function(){return null},setRoute:function(a){a&&a.length!==0||(a=this.getDefaultRoute()?[this.getDefaultRoute()]:[]);var c=a.slice(0),d=a.shift(),e=a.slice(0),f=this.state||this.getDefaultRoute(),g=this.getRoutes();if(Object.keys(g).length!==0)g.hasOwnProperty(d)&&(console.log('Setting State: "/'+d+(f?'" from "'+f:"")+'" for "'+this.attr("name")+'"'),g[d].call(this,f,e)),this.state=d;else for(var h in this.views)this.getView(h).setRoute(c.slice(0))},getType:function(){return"view"},getBindings:function(){return{}},getRoutes:function(){return{}},setup:function(){},setModel:function(a,b){this._models||(this._models={}),this._models[a]=b},getModel:function(a){if(this._models.hasOwnProperty(a))return this._models[a];throw"Model Not Found"},add:function(a,b,c){return this._queue.push({fn:a,args:b,wait:c}),this._running||this.next(),this},next:function(){this._running=!0;var a=this._queue.shift();a?(a.fn.apply(this,a.args),a.wait&&a.wait>0&&(this._process=setTimeout(proxy(function(){this.next()},this),a.wait))):this._running=!1},stop:function(){return this._queue=[],this._process&&(clearTimeout(this._process),this.next()),this},addClass:function(){this._target.addClass.apply(this._target,arguments)},hasClass:function(){this._target.hasClass.apply(this._target,arguments)},removeClass:function(){this._target.removeClass.apply(this._target,arguments)},load:function(){return this.add(this._load)},show:function(){return this.add(this._show)},hide:function(){return this.add(this._hide)},unload:function(){return this.add(this._unload)},appendTo:function(a){return this.add(this._appendTo,[a])},append:function(a){return this.add(this._append,[a])},remove:function(){return this.add(this._remove)},run:function(){return this.add(this._run,arguments)},_run:function(a,b,c){c?setTimeout(proxy(function(){a.call(b||this),this.next()},this),c):(a.call(b||this),this.next())},_load:function(){return this._loaded?(this.next(),void 0):(this._loadEvts.push(this.on("_load",this.onLoad,this)),this._loadEvts.push(this.on("_loaded",this.onDidLoad,this)),this.onWillLoad(),void 0)},_show:function(){if(this._visible)return this.next(),void 0;if(!this._loaded)throw Error("Invalid Request: Cannot show unloaded ViewController");this._showEvts.push(this.on("_appear",this.onAppear,this)),this._showEvts.push(this.on("_appeared",this.onDidAppear,this)),this.onWillAppear()},_hide:function(){return this._visible?(this._hideEvts.push(this.on("_disappear",this.onDisappear,this)),this._hideEvts.push(this.on("_disappeared",this.onDidDisappear,this)),this.onWillDisappear(),void 0):(this.next(),void 0)},_unload:function(){if(!this._loaded)return this.next(),void 0;if(this._visible)throw Error("Invalid Request: Cannot unload visible ViewController");this._unloadEvts.push(this.on("_unload",this.onUnload,this)),this._unloadEvts.push(this.on("_unloaded",this.onDidUnload,this)),this.onWillUnload()},_appendTo:function(a){a instanceof b?a._target.append(this._target):a.append(this._target),this.next()},_append:function(a){a instanceof b?this._target.append(a._target):this._target.append(a),this.next()},_remove:function(){this._target.remove(),this.next()},onWillLoad:function(){this.fire("_load")},onLoad:function(){var a=Object.keys(this._views).length;if(a===0)this.fire("_loaded");else for(var b in this._views){var c=this._views[b];c.once("load",proxy(function(){a--,a===0&&this.fire("_loaded")},this)),c.load()}},onDidLoad:function(){this._loaded=!0;for(var a=0,b=this._loadEvts.length;b>a;a++)this._loadEvts[a].detach();this._loadEvts=[],this.fire("load"),this.next()},onWillUnload:function(){this.fire("_unload")},onUnload:function(){var a=Object.keys(this._views).length;if(a===0)this.fire("_unloaded");else for(var b in this._views){var c=this._views[b];c.once("unload",proxy(function(){a--,a===0&&this.fire("_unloaded")},this)),c.unload()}},onDidUnload:function(){this._loaded=!1;for(var a=0,b=this._unloadEvts.length;b>a;a++)this._unloadEvts[a].detach();this._unloadEvts=[],this.fire("unload"),this.next()},onWillAppear:function(){function f(a,d){var h,e=a.match(/^([#$\.A-Za-z0-9\-_]+)(?:\((.*)\))?/),f=e[1],g=e[2],i=c.touch?"touchend":"click";if(f==="$target")f=this._target;else if(f==="$body")f=$("body");else if(this.hasView(f))f=this.getView(f);else{if(!this.hasElement(f))return;f=this.getElement(f)}for(var j in d)h=j==="touchclick"?i:j,typeof d[j]=="function"&&(g&&f instanceof jQuery?f.on(h,g,proxy(d[j],this)):f instanceof b?f.on(h,d[j],this):f.on(h,proxy(d[j],this)))}var a=this.getBindings();for(var g in a)f.call(this,g,a[g]);this._target.removeClass("hidden"),this.fire("_appear")},onAppear:function(){var b=Object.keys(this._views).length;if(b===0)this.fire("_appeared");else for(var c in this._views){var d=this._views[c];d.once("appear",proxy(function(){b--,b===0&&this.fire("_appeared")},this)),d.show()}},onDidAppear:function(){this._visible=!0;for(var b=0,c=this._showEvts.length;c>b;b++)this._showEvts[b].detach();this._showEvts=[],this.fire("appear"),this.next()},onWillDisappear:function(){for(var a in this._views)this.getView(a).detach();for(var b in this._elems)this.getElement(b).off();this.fire("_disappear")},onDisappear:function(){var b=Object.keys(this._views).length;if(b===0)this.fire("_disappeared");else for(var c in this._views){var d=this._views[c];d.once("disappear",proxy(function(){b--,b===0&&this.fire("_disappeared")},this)),d.hide()}},onDidDisappear:function(){this._target.addClass("hidden");for(var b=0,c=this._hideEvts.length;c>b;b++)this._hideEvts[b].detach();this._hideEvts=[],this._visible=!1,this.fire("disappear"),this.next()},attr:function(){var a=arguments;return a.length===1?this._attrs.hasOwnProperty(a[0])?this._attrs[a[0]]:!1:(a.length===2&&(this._attrs[a[0]]=a[1]),void 0)},find:function(){return this._target.find.apply(this._target,arguments)},getService:function(a){return this._app.getService(a)},getView:function(a){if(a instanceof b)return a;if(this._views[a]!==void 0)return this._views[a];throw Error('Invalid Request: View "'+a+'" not found')},getElement:function(a){if(this._elems[a]!==void 0)return this._elems[a];throw Error('Invalid Request: Element "'+a+'" not found')},hasView:function(a){return this._views[a]!==void 0},hasElement:function(a){return this._elems[a]!==void 0},addView:function(b,c,d,e,f){if(this.hasView(d))throw Error("Invalid Request: ViewController "+d+" already exists");if(!b)throw"Invalid ViewController";var g=a.View.get(e,c,d);this._views[d]=new b(this,g,this._app),f==="body"?$("body").append(this._views[d]._target):f&&this._target.append(this._views[d]._target)},removeView:function(a){this.hasView(a)&&(this._views[a].hide().unload().destroy(),delete this._views[a])},setParam:function(a,b){this._params[a]=b},getParam:function(a){return this._params[a]},clearParam:function(a){delete this._params[a]},bindData:function(a,b,c){for(var f,d=a==="$target"?this._target:this.getElement(a),e=d.childrenTo("[itemprop]"),g=0;e.length>g;g++)f=e[g].attr("itemprop"),f&&(e[g].get(0).tagName==="IMG"?b.hasOwnProperty(f)&&e[g].attr("src",b[f]):e[g].get(0).tagName==="SELECT"||e[g].get(0).tagName==="INPUT"?b.hasOwnProperty(f)&&e[g].val(""):b.hasOwnProperty(f)&&b[f]?e[g].text(b[f]):c||e[g].text(""))},goOnline:function(){for(var a in this._views)this._views[a].goOnline()},goOffline:function(){for(var a in this._views)this._views[a].goOffline()},setupAttributes:function(){if(!this._initialized){var a=h(this._target,/data-/);return a.hasOwnProperty("name")||(a.name=a.control),this._target.addClass("view"),this.typeList!==void 0&&this._target.addClass(this.typeList),this._target.addClass(a.name),a}},setupViews:function(){if(!this._initialized){for(var e,f,h,i,j,c=this._target.childrenTo("[data-control]"),d={},k=0;c.length>k;k++)f=c[k].attr("data-control"),e=c[k].attr("data-name"),i=c[k].attr("data-template"),i&&i.length>0&&(h=a.View.get(i,f,e),c[k].html(h.html()),g(h,c[k]),c[k].removeAttr("data-template")),e=e||f,j=b.get(f),d[e]=new j(this,c[k],this._app);return d}},setupElements:function(){if(!this._initialized){for(var c,a=this._target.childrenTo("[data-name]:not([data-control])"),b={},d=0;a.length>d;d++)c=a[d].attr("data-name"),c.length>0&&(b[c]=a[d],a[d].removeAttr("data-name").addClass(c));return b}},toString:function(){return"["+this.getType()+" "+this.attr("name")+"]"},destroy:function(){for(var a in this._views)this._views[a].destroy(),delete this._views[a];for(var b in this._elems)this._elems[b].destroy(),delete this._elems[b];delete this._views,delete this._elems,delete this._target,delete this._parent,delete this._source,delete this._queue}}).include(Events),b.views={view:b},b.extend=function(a){if(!a.hasOwnProperty("getType"))throw'Missing Implementation: ViewController missing "getType" implementation';var c=Class.extend.call(this,a),d=a.getType();if(b.views.hasOwnProperty(d))throw'Duplicate Class: ViewController "'+d+'" is already defined';return c.prototype.typeList?c.prototype.typeList+=" "+d:c.prototype.typeList=d,c.extend=b.extend,b.views[d]=c},b.get=function(a){if(this.views.hasOwnProperty(a))return this.views[a];throw'Invalid Resource: ViewController "'+a+'" not defined'},a.ViewController=b}(Clementine),function(a){var b=function(){function c(a,b,c){return $.ajax({async:c!==!0,contentType:"text/html; charset=utf-8",dataType:"text",timeout:1e4,url:"templates/"+a,success:function(c){b(a,c)},error:function(){throw"Error: template not found"}}).responseText}var a={},b={};return a.get=function(a,c,d){var f=[];if(!a||!b.hasOwnProperty(a))throw"Path "+a+" has not been loaded";$("<div>"+b[a]+"</div>").children().each(function(){f.push($(this))});for(var h=0;f.length>h;h++)if(!(c!==void 0&&f[h].attr("data-control")!==c||d!==void 0&&f[h].attr("data-name")!==d))return f[h].clone();throw"Could not find view "+c+" at "+a},a.register=function(a,d){function g(a,c){b[a]=c,f--,f===0&&d()}var e,f=a.length;if(f===0)return d();for(var h=0;a.length>h;h++)e=a[h],c(a[h],proxy(g,this))},a}();a.View=b}(Clementine),function(a){var b=Class.extend({initialize:function(a){this.path=a},getType:function(){return"service"},getPrefix:function(){return""},_getPrefix:function(){if(!this.path)throw{type:"Configuration Error",message:"Missing base url"};return(this.path||"")+this.getPrefix()},request:function(a,b,c,d,e,f,g){if(!e||!f)throw{type:"Invalid Request",message:"Missing callback function"};d=d||function(a){return a},g=g||this,$.ajax({url:this._getPrefix()+a,type:b,timeout:6e4,data:c,success:function(a){if(a===!1||a==="false")return f.call(g),void 0;try{a=JSON.parse(a)}catch(b){return f.call(g),void 0}var c;try{c=d.call(g,a)}catch(h){throw f.call(g,h),h}e.call(g,c)},error:function(){f.call(g,!0)}})},modelOrId:function(a){return a&&typeof a=="object"&&a.hasOwnProperty("id")&&(a=a.id),a?a:void 0},destroy:function(){delete this.eventTarget}}).include(a.Events);b.services={service:b},b.extend=function(a){for(var c=Class.extend.call(this,a),d=a.getType(),e=["getType"],f=0,g=e.length;g>f;f++){if(!a.hasOwnProperty(e[f]))throw"Class missing '"+e[f]+"()' implementation";c[e[f]]=a[e[f]]}return c.extend=arguments.callee,b.services[d]=c},b.get=function(a){if(a==="service")return this;if(!this.services.hasOwnProperty(a))throw"Service '"+a+'" not found';return this.services[a]},a.Service=b}(Clementine),function(a){function c(b){if(typeof a.modules[b]!==void 0)return a.modules[b];throw"Could not require module"}var b=function(){var b={},c={},d={};return a.modules={},{addModule:function(a,c,d){if(!a.match(/[\^\-A-Za-z_]/g))throw"Invalid module name";var e={name:a,fn:c,req:d!==void 0?d:[]};b[a]=e},loadModule:function(e){if(!c.hasOwnProperty(e)&&b[e]!==void 0){c[e]=!0;for(var f=0,g=b[e].req.length;g>f;f++)b[e].req[f]!==e&&this.loadModule(b[e].req[f]);b[e].fn.call(window,d),a.modules[e]=d}}}}();a.add=function(){var b=arguments,c=b[0],d=typeof b[1]=="function"?b[1]:null,e=b[2];a.Loader.addModule(c,d,e)},a.use=function(){var b=Array.prototype.slice.call(arguments),c=b[b.length-1],d=clone(b).splice(0,b.length-1);if(typeof d[0]!="function")for(var e=0,f=d.length;f>e;e++)a.Loader.loadModule(d[e]);c.call(window,a)},window.include=c,a.Loader=b}(Clementine),function(a){var b=Class.extend({initialize:function(b){if(!b.hasOwnProperty("name")||RegExp(/[^A-Za-z:0-9_\[\]]/g).test(b.name))throw"Invalid Application Name";this.config=b,this.ready=!1,this.loaded=!1,this.config.name=b.name,this.config.required=b.hasOwnProperty("required")?b.required:[],this.config.services=b.hasOwnProperty("services")?b.services:[],this.config.views=b.hasOwnProperty("views")?b.views:[],this.config.paths=b.hasOwnProperty("paths")?b.paths:{},this.config.auth=b.hasOwnProperty("auth")?b.auth:null,this.env=b.env||"DEV";for(var c=0;this.config.required.length>c;c++)a.Loader.loadModule(this.config.required[c]);this.services={},this.config.auth?this.authenticate():this.loadServices(),$(document).ready(proxy(this.onReady,this))},getPath:function(){return this.config.paths[this.env]},authenticate:function(){var b=a.Service.get(this.config.auth);if(!this.config.paths.hasOwnProperty(this.env))throw"Invalid Service Path: Missing path for environment";var c=this.config.paths[this.env];this.services[this.config.auth]=new b(c),this.services[this.config.auth].on("token",this.onToken,this);var d=this.services[this.config.auth].getToken();d?(console.log("Token acquired: "+d),this.loadServices(d)):(console.log("Warning: Token not found: Services unauthenticated"),this.loadServices())},loadViews:function(){var b=this.config.views;return b.length===0?(this.onLoad(),void 0):(a.View.register(b,proxy(function(){this.onLoad()},this)),void 0)},loadServices:function(b){var c=this.config.auth,d=this.config.services;if(d.length===0)return this.loadViews(),void 0;if(!this.config.paths.hasOwnProperty(this.env))throw"Invalid Service Path: Missing path for environment";for(var f,g,e=this.config.paths[this.env],h=0;d.length>h;h++)c&&d[h]===c||(f=a.Service.get(d[h]),g=new f(e),b&&typeof g.getTokenService=="function"&&g.setToken(b),this.services[d[h]]=g,console.log("Service Loaded: '"+g.getType()+"'"));this.loadViews()},onToken:function(a){var b=this.config.auth;if(a.data){var c=a.data;for(var d in this.services)d!==b&&this.services[d].setToken(c);console.log("Token acquired: "+c)}},onReady:function(){this.ready=!0,this.loaded&&this.launch()},onLoad:function(){this.loaded=!0,this.ready&&this.launch()},launch:function(){var b=$("[data-root]"),c=b.attr("data-control"),d=b.attr("data-name")||c;if(!c||!d)throw"Syntax Error: Root view not found";b.removeAttr("data-root");var e=a.ViewController.get(c),b=new e(null,b,this);this.root=b,$(window).bind("hashchange",proxy(this.onHashChange,this)),b.on("load",function(){$(window).trigger("hashchange"),b.show()}),b.load(),console.log("Launching App: "+this.config.name)},onHashChange:function(){var a=location.hash;a?this.root.setRoute(a.replace("#","").split("/")):this.root.setRoute()},getService:function(a){return this.services[a]}});a.config=function(b){$(document).ready(function(){b&&(window.Application=new a.Application(b))})},a.Application=b}(Clementine)